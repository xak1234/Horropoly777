<!-- Payment System Integration for Horropoly -->
<!-- Add this to your existing index.html -->

<!-- Payment System Script -->
<script type="module">
  // Import the payment system
  import { initializePaymentSystem } from './payment-system.js';
  
  // Initialize the payment system
  const paymentSystem = initializePaymentSystem();
  
  // Check payment status when page loads
  document.addEventListener('DOMContentLoaded', function() {
    checkPaymentStatus();
    
    // Check for payment completion from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment_status');
    const sessionId = urlParams.get('session_id');
    
    if (paymentStatus === 'success' && sessionId) {
      handlePaymentSuccess(sessionId);
    }
  });
  
  // Check if user has already paid - ALWAYS verify with server
  async function checkPaymentStatus() {
    const sessionId = localStorage.getItem('stripe_session_id');
    const userId = localStorage.getItem('userId');
    
    if (sessionId && userId) {
      // ALWAYS verify with server - never trust localStorage alone
      try {
        console.log('üîç Verifying payment with server...');
        const verified = await paymentSystem.verifyPayment(sessionId);
        console.log('Server verification result:', verified);
        
        if (verified.verified && verified.deviceAllowed) {
          console.log('‚úÖ Payment verified - unlocking multiplayer');
          unlockMultiplayer();
        } else {
          console.log('‚ùå Payment verification failed:', verified.reason);
          // Payment verification failed, reset status
          localStorage.removeItem('multiplayerPaid');
          localStorage.removeItem('stripe_session_id');
          lockMultiplayer();
          if (verified.reason) {
            showPaymentError(`Access denied: ${verified.reason}`);
          }
        }
      } catch (error) {
        console.error('‚ùå Payment verification error:', error);
        // If verification fails, lock access
        localStorage.removeItem('multiplayerPaid');
        localStorage.removeItem('stripe_session_id');
        lockMultiplayer();
        showPaymentError('Payment verification failed. Please try again.');
      }
    } else {
      console.log('üîí No payment session found - locking multiplayer');
      lockMultiplayer();
    }
  }
  
  // Handle successful payment
  async function handlePaymentSuccess(sessionId) {
    const userId = localStorage.getItem('userId') || crypto.randomUUID();
    localStorage.setItem('userId', userId);
    
    console.log('üí∞ Processing successful payment...');
    
    // Record payment in Firebase
    const paymentData = {
      payment_intent: sessionId,
      session_id: sessionId
    };
    
    const recorded = await paymentSystem.recordPayment(userId, paymentData);
    
    if (recorded) {
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Unlock multiplayer
      localStorage.setItem('multiplayerPaid', 'true');
      localStorage.setItem('stripe_session_id', sessionId);
      
      unlockMultiplayer();
      
      // Show success message
      showPaymentSuccess();
    } else {
      showPaymentError('Payment recording failed. Please contact support.');
    }
  }
  
  // Unlock multiplayer access
  function unlockMultiplayer() {
    console.log('üéÆ Unlocking multiplayer access');
    
    // Hide paywall
    const paywall = document.getElementById('multiplayer-payment-wall');
    if (paywall) {
      paywall.style.display = 'none';
    }
    
    // Show multiplayer content
    const multiplayerContent = document.getElementById('multiplayer-content');
    if (multiplayerContent) {
      multiplayerContent.style.display = 'block';
    }
    
    // Update any status displays
    const statusDiv = document.getElementById('payment-status');
    if (statusDiv) {
      statusDiv.className = 'payment-status unlocked';
      statusDiv.innerHTML = '‚úÖ Multiplayer Access: Unlocked';
    }
  }
  
  // Lock multiplayer access
  function lockMultiplayer() {
    console.log('üîí Locking multiplayer access');
    
    // Show paywall
    const paywall = document.getElementById('multiplayer-payment-wall');
    if (paywall) {
      paywall.style.display = 'block';
    }
    
    // Hide multiplayer content
    const multiplayerContent = document.getElementById('multiplayer-content');
    if (multiplayerContent) {
      multiplayerContent.style.display = 'none';
    }
    
    // Update any status displays
    const statusDiv = document.getElementById('payment-status');
    if (statusDiv) {
      statusDiv.className = 'payment-status locked';
      statusDiv.innerHTML = 'üîí Multiplayer Access: Locked';
    }
  }
  
  // Show payment success message
  function showPaymentSuccess() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    modal.innerHTML = `
      <div style="
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #00ff00;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        color: white;
        max-width: 400px;
        width: 90%;
      ">
        <h2 style="color: #00ff00; margin-bottom: 20px;">‚úÖ Payment Successful!</h2>
        <p style="margin-bottom: 20px;">Multiplayer access has been unlocked for this device.</p>
        <p style="font-size: 12px; color: #ccc; margin-bottom: 20px;">
          üîí Device fingerprint recorded<br>
          üõ°Ô∏è Fraud protection active<br>
          üì± Works on up to 3 devices
        </p>
        <button onclick="this.parentElement.parentElement.remove()" style="
          background: linear-gradient(45deg, #00ff00, #00cc00);
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
        ">üéÆ Start Playing!</button>
      </div>
    `;
    
    document.body.appendChild(modal);
  }
  
  // Show payment error message
  function showPaymentError(message) {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    modal.innerHTML = `
      <div style="
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #ff0000;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        color: white;
        max-width: 400px;
        width: 90%;
      ">
        <h2 style="color: #ff0000; margin-bottom: 20px;">‚ùå Payment Error</h2>
        <p style="margin-bottom: 20px;">${message}</p>
        <button onclick="this.parentElement.parentElement.remove()" style="
          background: #333;
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
        ">‚ùå Close</button>
      </div>
    `;
    
    document.body.appendChild(modal);
  }
  
  // Make functions globally available for button clicks
  window.unlockMultiplayer = unlockMultiplayer;
  window.lockMultiplayer = lockMultiplayer;
  window.showPaymentSuccess = showPaymentSuccess;
  window.showPaymentError = showPaymentError;
</script>

<!-- Payment Status Display (add this to your HTML body) -->
<div id="payment-status" class="payment-status locked" style="
  text-align: center;
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
  font-weight: bold;
  background: rgba(255, 0, 0, 0.2);
  border: 1px solid #ff0000;
  color: #ff0000;
">
  üîí Multiplayer Access: Locked
</div>

<!-- Enhanced Payment Wall (add this before your multiplayer content) -->
<div id="multiplayer-payment-wall" style="
  text-align: center;
  padding: 20px;
  background: rgba(255, 0, 0, 0.1);
  border: 2px solid #ff0000;
  border-radius: 8px;
  margin-bottom: 20px;
">
  <p style="color: #ff0000; font-weight: bold; margin-bottom: 15px;">üîí Premium Multiplayer Access</p>
  <p style="color: #fff; margin-bottom: 15px;">Unlock multiplayer features for just ¬£1.99 (one-time payment)</p>
  <p style="color: #ccc; font-size: 12px; margin-bottom: 15px;">
    üîí Secure payment via Stripe<br>
    üõ°Ô∏è Fraud protection enabled<br>
    üì± Works on up to 3 devices
  </p>
  <button id="unlock-multiplayer-btn" style="
    background: linear-gradient(45deg, #ff0000, #cc0000);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    box-shadow: 0 4px 8px rgba(255,0,0,0.3);
  " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
    üîì Unlock Multiplayer - ¬£1.99
  </button>
</div>

<!-- Multiplayer Content (wrap your existing multiplayer content in this div) -->
<div id="multiplayer-content" style="display: none;">
  <!-- Your existing multiplayer content goes here -->
  <p>Your multiplayer content will appear here after payment</p>
</div>

<!-- CSS for payment status -->
<style>
.payment-status {
  text-align: center;
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
  font-weight: bold;
}

.payment-status.unlocked {
  background: rgba(0, 255, 0, 0.2);
  border: 1px solid #00ff00;
  color: #00ff00;
}

.payment-status.locked {
  background: rgba(255, 0, 0, 0.2);
  border: 1px solid #ff0000;
  color: #ff0000;
}
</style>

<!-- Add event listener for unlock button -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const unlockBtn = document.getElementById('unlock-multiplayer-btn');
  if (unlockBtn) {
    unlockBtn.addEventListener('click', () => {
      // This will be handled by the payment system
      console.log('Payment button clicked');
    });
  }
});
</script> 