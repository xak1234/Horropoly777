<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Random Game Starting Issue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .fix-section {
            background-color: #2a2a2a;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .fix-title {
            color: #ff9800;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .code-block {
            background-color: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 10px 0;
        }
        .error {
            background-color: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ² Fix: Random Game Starting Issue</h1>
    
    <div class="error">
        <strong>ğŸš¨ Issue Identified:</strong><br>
        Games are starting randomly and inconsistently. Players are being treated as "already in room" when they shouldn't be, causing confusion in the multiplayer flow.
    </div>

    <div class="fix-section">
        <div class="fix-title">ğŸ” Root Cause Analysis</div>
        <p>Based on your logs, here are the issues:</p>
        
        <h4>1. Stale Player Data</h4>
        <div class="code-block">
// From your logs - both players show as "already in room":
ğŸ” Checking if player "Hannibal" already exists in room: {
    foundExistingPlayer: true  // âŒ Should be false for new player
}

ğŸ” Checking if player "Ghostface" already exists in room: {
    foundExistingPlayer: true  // âŒ Should be false for new player
}
        </div>
        
        <h4>2. Room State Confusion</h4>
        <ul>
            <li>Master shows: <code>ğŸ“Š Room status: 2/2 players</code> (room appears full)</li>
            <li>Client shows: <code>ğŸ“Š Room status: 1/2 players</code> (room appears to have space)</li>
            <li>Both players end up with only 1 player in the final room state</li>
        </ul>
        
        <h4>3. Invalid Player Persistence</h4>
        <p>Old/invalid players from previous sessions are persisting in the room, causing false matches.</p>
    </div>

    <div class="fix-section">
        <div class="fix-title">ğŸ› ï¸ Fixes Applied</div>
        
        <h4>1. Enhanced Player Validation & Cleanup</h4>
        <div class="code-block">
// Enhanced player validation - filter out stale/invalid players
const validPlayers = currentPlayers.filter(p => {
    if (!p || !p.userId || !p.name) {
        console.log('ğŸ—‘ï¸ Filtering out player with missing data:', p);
        return false;
    }
    
    if (p.name === 'undefined' || p.userId === 'undefined') {
        console.log('ğŸ—‘ï¸ Filtering out player with undefined data:', p);
        return false;
    }
    
    return true;
});

// Auto-cleanup invalid players
if (validPlayers.length !== currentPlayers.length) {
    console.log(`ğŸ§¹ Cleaning up room: removed ${currentPlayers.length - validPlayers.length} invalid players`);
    await updateDoc(gameRoomRef, {
        players: validPlayers,
        lastActivity: Date.now()
    });
}
        </div>
        
        <h4>2. Better Room State Debugging</h4>
        <div class="code-block">
console.log(`ğŸ  Room details:`, {
    roomId: roomId,
    roomName: gameState.roomName,
    createdAt: gameState.createdAt,
    lastActivity: gameState.lastActivity,
    currentPlayers: validPlayers.map(p => ({ 
        name: p.name, 
        userId: p.userId, 
        isHost: p.isHost 
    }))
});
        </div>
        
        <h4>3. Enhanced Player Existence Checking</h4>
        <div class="code-block">
console.log(`ğŸ” Checking if player "${playerName}" already exists in room:`, {
    searchingFor: playerName,
    existingPlayers: validPlayers.map(p => p.name),
    existingPlayersDetailed: validPlayers.map(p => ({ name: p.name, userId: p.userId })),
    foundExistingPlayer: !!existingPlayer,
    exactMatch: existingPlayer ? existingPlayer.name : null
});
        </div>
    </div>

    <div class="fix-section">
        <div class="fix-title">ğŸ§ª Testing the Fix</div>
        
        <h4>Step-by-Step Testing:</h4>
        <ol>
            <li><strong>Clear existing rooms:</strong> Use the cleanup utility to remove stale data</li>
            <li><strong>Create fresh room:</strong> One player creates a new room</li>
            <li><strong>Join with second player:</strong> Second player joins the same room</li>
            <li><strong>Monitor console logs:</strong> Look for the new enhanced logging</li>
        </ol>
        
        <div class="info">
            <strong>ğŸ’¡ Debug Commands:</strong>
            <div class="code-block">
// Use these in browser console to debug:
debugRoomStatus("ELM_STREET");
cleanupInvalidPlayers("ELM_STREET");
checkRoom("ELM_STREET");
            </div>
        </div>
    </div>

    <div class="fix-section">
        <div class="fix-title">ğŸ¯ Expected Results After Fix</div>
        
        <div class="success">
            <strong>âœ… What You Should See Now:</strong>
            <div class="code-block">
// For a NEW player joining:
ğŸ§¹ Cleaning up room: removed 1 invalid players
ğŸ  Room details: {
    roomId: "ELM_STREET",
    currentPlayers: []  // Clean room
}
ğŸ” Checking if player "Hannibal" already exists in room: {
    searchingFor: "Hannibal",
    existingPlayers: [],
    foundExistingPlayer: false  // âœ… Correct!
}
â• Player "Hannibal" is NEW, proceeding to add to room
âœ… joinGameRoom completed successfully

// Then for second player:
ğŸ” Checking if player "Ghostface" already exists in room: {
    searchingFor: "Ghostface",
    existingPlayers: ["Hannibal"],
    foundExistingPlayer: false  // âœ… Correct!
}
â• Player "Ghostface" is NEW, proceeding to add to room
âœ… joinGameRoom completed successfully
            </div>
        </div>
    </div>

    <div class="fix-section">
        <div class="fix-title">ğŸ”„ If Issues Persist</div>
        
        <div class="warning">
            <strong>âš ï¸ Additional Troubleshooting:</strong>
            
            <h4>1. Clear All Rooms</h4>
            <div class="code-block">
// Use this to completely reset all rooms:
// (Open browser console and run)
import('./firebase-init.js').then(async ({ getDb }) => {
    const { collection, getDocs, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js');
    const db = await getDb();
    const rooms = await getDocs(collection(db, 'gameRooms'));
    rooms.forEach(doc => deleteDoc(doc.ref));
    console.log('All rooms cleared');
});
            </div>
            
            <h4>2. Check for Multiple Browser Sessions</h4>
            <p>Make sure you don't have multiple tabs/windows open with the same game, as this can cause player conflicts.</p>
            
            <h4>3. Browser Cache Issues</h4>
            <p>Try hard refresh (Ctrl+F5) or clear browser cache if issues persist.</p>
        </div>
    </div>

    <div class="fix-section">
        <div class="fix-title">ğŸ® Game Starting Logic</div>
        <p>The game should start automatically when:</p>
        <ul>
            <li>âœ… Room has exactly <code>maxPlayers</code> (usually 2) valid players</li>
            <li>âœ… Game hasn't already started (<code>gameStarted: false</code>)</li>
            <li>âœ… All players have valid names and userIds</li>
        </ul>
        
        <div class="code-block">
// Auto-start conditions in the logs:
ğŸ® Auto-start check - isHost: false gameStarted: false playersLength: 2 maxPlayers: 2
// Should trigger: "Room is now full, triggering auto-start check"
        </div>
    </div>

    <script>
        console.log('ğŸ² Random Game Starting Fix Documentation Loaded');
        console.log('ğŸ”§ Enhanced logging and cleanup mechanisms applied');
        console.log('ğŸ“Š Monitor console for detailed room state information');
        
        // Add debugging helper
        window.debugGameStarting = function() {
            console.log('ğŸ” Current game starting state:', {
                isMultiplayerGame: window.isMultiplayerGame || 'not set',
                currentRoomId: window.currentRoomId || 'not set',
                isHost: window.isHost || 'not set',
                gameStarted: window.gameStarted || 'not set',
                players: window.players ? window.players.map(p => ({
                    name: p.name, 
                    userId: p.userId, 
                    isHost: p.isHost
                })) : 'not set'
            });
        };
        
        console.log('ğŸ’¡ Use debugGameStarting() to check current state');
    </script>
</body>
</html>
