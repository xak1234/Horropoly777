<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Start Multiplayer Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #444;
        }
        h1 {
            color: #ff6b6b;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #fff;
            font-size: 16px;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background: #ff5252;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #2d5a2d;
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        .status.error {
            background: #5a2d2d;
            border: 1px solid #f44336;
            color: #f44336;
        }
        .status.info {
            background: #2d4a5a;
            border: 1px solid #2196f3;
            color: #2196f3;
        }
        .room-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #ff6b6b;
        }
        .player-list {
            margin-top: 10px;
        }
        .player {
            background: #444;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
        }
        .player.host {
            border-left: 3px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Force Start Multiplayer Game</h1>
        <p>Use this tool to force-start multiplayer games that are stuck waiting for players due to disconnect handler issues.</p>
        
        <div class="form-group">
            <label for="roomId">Room ID:</label>
            <input type="text" id="roomId" placeholder="Enter room ID (e.g., RACCOON_CITY)" value="RACCOON_CITY">
        </div>
        
        <button onclick="checkRoomStatus()">Check Room Status</button>
        <button onclick="forceStartGame()" id="forceStartBtn" disabled>Force Start Game</button>
        <button onclick="cleanupInvalidPlayers()" id="cleanupBtn" disabled>Cleanup Invalid Players</button>
        
        <div id="status" class="status"></div>
        <div id="roomInfo" style="display: none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA0K3E8nNhWUTsGGatzxOUqL_Nq5zEJZnw",
            authDomain: "horropoly-multiplayer.firebaseapp.com",
            projectId: "horropoly-multiplayer",
            storageBucket: "horropoly-multiplayer.appspot.com",
            messagingSenderId: "1053801700539",
            appId: "1:1053801700539:web:d1234567890abcdef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRoomData = null;

        window.checkRoomStatus = async function() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId) {
                showStatus('Please enter a room ID', 'error');
                return;
            }

            showStatus('Checking room status...', 'info');
            
            try {
                const roomRef = doc(db, 'gameRooms', roomId);
                const roomDoc = await getDoc(roomRef);
                
                if (!roomDoc.exists()) {
                    showStatus(`Room "${roomId}" not found`, 'error');
                    document.getElementById('roomInfo').style.display = 'none';
                    return;
                }

                currentRoomData = roomDoc.data();
                displayRoomInfo(roomId, currentRoomData);
                
                // Enable buttons based on room state
                const forceStartBtn = document.getElementById('forceStartBtn');
                const cleanupBtn = document.getElementById('cleanupBtn');
                
                if (currentRoomData.gameStarted) {
                    showStatus('Game is already started', 'info');
                    forceStartBtn.disabled = true;
                } else {
                    forceStartBtn.disabled = false;
                }
                
                // Check for invalid players
                const players = currentRoomData.players || [];
                const invalidPlayers = players.filter(p => !p || !p.userId || !p.name);
                cleanupBtn.disabled = invalidPlayers.length === 0;
                
            } catch (error) {
                console.error('Error checking room:', error);
                showStatus(`Error checking room: ${error.message}`, 'error');
            }
        };

        window.forceStartGame = async function() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId || !currentRoomData) {
                showStatus('Please check room status first', 'error');
                return;
            }

            if (currentRoomData.gameStarted) {
                showStatus('Game is already started', 'error');
                return;
            }

            showStatus('Force starting game...', 'info');
            
            try {
                const roomRef = doc(db, 'gameRooms', roomId);
                await updateDoc(roomRef, {
                    gameStarted: true,
                    gameStartedAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                });
                
                showStatus('‚úÖ Game force-started successfully! Players should now see the game board.', 'success');
                
                // Refresh room status
                setTimeout(() => {
                    checkRoomStatus();
                }, 1000);
                
            } catch (error) {
                console.error('Error force starting game:', error);
                showStatus(`Error force starting game: ${error.message}`, 'error');
            }
        };

        window.cleanupInvalidPlayers = async function() {
            const roomId = document.getElementById('roomId').value.trim();
            if (!roomId || !currentRoomData) {
                showStatus('Please check room status first', 'error');
                return;
            }

            showStatus('Cleaning up invalid players...', 'info');
            
            try {
                const players = currentRoomData.players || [];
                const validPlayers = players.filter(p => p && p.userId && p.name);
                const invalidCount = players.length - validPlayers.length;
                
                if (invalidCount === 0) {
                    showStatus('No invalid players found', 'info');
                    return;
                }

                const roomRef = doc(db, 'gameRooms', roomId);
                await updateDoc(roomRef, {
                    players: validPlayers,
                    lastUpdated: new Date().toISOString()
                });
                
                showStatus(`‚úÖ Cleaned up ${invalidCount} invalid players. ${validPlayers.length} valid players remain.`, 'success');
                
                // Refresh room status
                setTimeout(() => {
                    checkRoomStatus();
                }, 1000);
                
            } catch (error) {
                console.error('Error cleaning up players:', error);
                showStatus(`Error cleaning up players: ${error.message}`, 'error');
            }
        };

        function displayRoomInfo(roomId, roomData) {
            const roomInfo = document.getElementById('roomInfo');
            const players = roomData.players || [];
            const validPlayers = players.filter(p => p && p.userId && p.name);
            const invalidPlayers = players.filter(p => !p || !p.userId || !p.name);
            
            let html = `
                <div class="room-info">
                    <h3>Room: ${roomId}</h3>
                    <p><strong>Game Started:</strong> ${roomData.gameStarted ? '‚úÖ Yes' : '‚ùå No'}</p>
                    <p><strong>Players:</strong> ${validPlayers.length}/${roomData.maxPlayers || 2}</p>
                    <p><strong>Created:</strong> ${new Date(roomData.createdAt).toLocaleString()}</p>
                    ${invalidPlayers.length > 0 ? `<p><strong>Invalid Players:</strong> ${invalidPlayers.length} (can be cleaned up)</p>` : ''}
                    
                    <div class="player-list">
                        <h4>Players:</h4>
            `;
            
            validPlayers.forEach(player => {
                html += `
                    <div class="player ${player.isHost ? 'host' : ''}">
                        <span>${player.name} ${player.isHost ? '(Host)' : ''}</span>
                        <span>${player.userId}</span>
                    </div>
                `;
            });
            
            if (invalidPlayers.length > 0) {
                html += `<h4>Invalid Players (${invalidPlayers.length}):</h4>`;
                invalidPlayers.forEach((player, index) => {
                    html += `
                        <div class="player" style="background: #5a2d2d;">
                            <span>Invalid Player ${index + 1}</span>
                            <span>Missing data</span>
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                </div>
            `;
            
            roomInfo.innerHTML = html;
            roomInfo.style.display = 'block';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        // Auto-fill room ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        if (roomFromUrl) {
            document.getElementById('roomId').value = roomFromUrl;
            // Auto-check room status
            setTimeout(() => {
                checkRoomStatus();
            }, 500);
        }
    </script>
</body>
</html>
